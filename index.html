<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combat Damage Meter</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <!-- Chart.js zoom plugin for pan/zoom functionality -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        :root {
            /* Cyberpunk 테마 - 기본 색상 */
            --bg-color:         #0a0a0f;  /* Deep dark blue-black */
            --bg-soft:          #13131a;  /* Dark purple-grey */
            --bg-card:          #1a1a24;  /* Slightly lighter */
            --bg-hover:         #22222e;
            --text-color:       #f0f0ff;  /* Slight blue tint */
            --text-dim:         #a8a8b8;
            --text-bright:      #ffffff;
            --border-color:     rgba(138, 43, 226, 0.2);  /* Purple glow */
            --border-hover:     rgba(138, 43, 226, 0.4);
            
            /* 네온 악센트 색상 */
            --primary-color:    #8B2BE2;  /* Electric purple */
            --secondary-color:  #00D4FF;  /* Cyan */
            --danger-color:     #FF0080;  /* Hot pink */
            --success-color:    #00FF88;  /* Neon green */
            --warning-color:    #FFB800;  /* Amber */
            --info-color:       #B794F4;  /* Lavender */
            
            /* 그래프 및 차트 색상 */
            --chart-1:          #FF006E;
            --chart-2:          #00D9FF;
            --chart-3:          #00FF88;
            --chart-4:          #FFB700;
            --chart-5:          #8B5CF6;
            --chart-bg:         rgba(255, 255, 255, 0.03);

            /* 버튼 스타일 - 네온 효과 */
            --btn-bg:           rgba(139, 43, 226, 0.1);
            --btn-bg-hover:     rgba(139, 43, 226, 0.2);
            --btn-border:       rgba(139, 43, 226, 0.3);
            --btn-text:         #e0e0ff;
            --btn-text-hover:   #ffffff;
            --btn-bg-active:    var(--primary-color);
            --btn-text-active:  #ffffff;

            /* 상태 색상 */
            --status-green:     #00FF88;
            --status-red:       #FF006E;
            --status-yellow:    #FFB700;
            --status-border:    rgba(255,255,255,0.2);
            
            /* 순위별 악센트 - 더 생동감 있게 */
            --accent-me:        #00FF88;
            --accent-gold:      #FFA500;  /* Orange-gold */
            --accent-silver:    #B794F4;  /* Lavender silver */
            --accent-bronze:    #F6AD55;  /* Warm orange */
            
            /* 그림자 효과 */
            --shadow-sm:        0 2px 4px rgba(0,0,0,0.3);
            --shadow-md:        0 4px 12px rgba(0,0,0,0.4);
            --shadow-lg:        0 8px 24px rgba(0,0,0,0.5);
            --shadow-glow:      0 0 20px rgba(139, 43, 226, 0.5);
            --shadow-neon:      0 0 30px rgba(139, 43, 226, 0.7);
            
            /* 추가 색상 */
            --primary-dim:      #0097A7;
            --bg-tertiary:      #303030;
            --bg-dark:          #181818;
            --text-secondary:   #bbbbbb; /* 가독성 향상 */
        }
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', '맑은 고딕', 'Malgun Gothic', Roboto, sans-serif;
            font-size: 1em;
            margin: 0;
            padding: 0;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 95vh;
        }
        .panel {
            margin-bottom: 16px;
            background: var(--bg-soft);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }
        
        .panel:hover {
            border-color: var(--border-hover);
            box-shadow: var(--shadow-lg);
        }
        

        .btn {
            padding: 6px 10px;
            background: var(--btn-bg);
            color: var(--btn-text);
            border: 1px solid var(--btn-border);
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .btn i {
            font-size: 1.1em;
        }        
        .btn:hover {
            background: var(--btn-bg-hover);
            color: var(--btn-text-hover);
            box-shadow: 0 2px 12px rgba(139, 43, 226, 0.4), 0 0 20px rgba(139, 43, 226, 0.2);
            transform: translateY(-2px);
            border-color: rgba(139, 43, 226, 0.5);
        }
        .btn:active {
            transform: scale(0.97); /* 눌린 효과 */
        }
        .btn.active {
            background: var(--btn-bg-active);  
            color: var(--btn-text-active);   
            box-shadow: 0 0 20px rgba(139, 43, 226, 0.6), inset 0 0 10px rgba(255,255,255,0.2);
            text-shadow: 0 0 10px rgba(255,255,255,0.8);
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--status-red);
            margin-left: 8px;
            vertical-align: middle;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 0 15px currentColor;
        }
        
        .status-indicator::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            background: inherit;
            opacity: 0.3;
            animation: pulse 2s infinite;
        }
        
        .status-connected {
            background: var(--status-green);
            box-shadow: 0 0 15px var(--status-green);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.3); opacity: 0.1; }
            100% { transform: scale(1); opacity: 0.3; }
        }

            
        input[type="checkbox"] {
            appearance: none;/* 기본 체크박스 제거 */
            width: 18px;
            height: 18px;
            margin-right: 4px;
            border-radius: 4px;
            border: 1px solid var(--text-dim);
            background-color: transparent;
            transition: background 0.2s, border 0.2s;
            display: grid;
            place-items: center;
        }
        input[type="checkbox"]:hover {
            border-color: var(--text-color);
        }
        input[type="checkbox"]::after {
            content: "✔";
            font-size: 12px;
            color: var(--text-color);
            opacity: 0;
            transform: scale(0.8);
            transition: opacity 0.15s ease;
        }
        input[type="checkbox"]:checked::after {
            opacity: 1;
        }

        .combobox {
          background-color: #2a2a2a;
          color: #e0e0e0;
          border: 1px solid var(--border-color);
          padding: 6px 8px;
          padding-right: 26px;
          border-radius: 6px;
          font-size: 0.85em;
          appearance: none;     /* 화살표 제거 (커스터마이징 가능) */
          -webkit-appearance: none;
          -moz-appearance: none;
          background-image: url("data:image/svg+xml;charset=UTF-8,<svg fill='%23aaa' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
          background-repeat: no-repeat;
          background-position: right 6px center;
          background-size: 16px;
          flex-shrink: 0;
        }
        .divider {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 8px 0;
            opacity: 0.5;
        }


        .options-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 2px;
            min-height: 40px;
            flex-wrap: wrap;
            padding: 4px 0;
        }
        
        .options-bar label {
            color: var(--btn-text);
            font-size: 0.85em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            user-select: none;
            margin: 0;
        }
        
        .options-bar label i {
            font-size: 1.1em;
        }


            
        .meter-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-color);
            flex-wrap: wrap;
        }
        .my-text-box {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: rgba(40, 40, 40, 0.8); /* 반투명 다크 */
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.85em;
            transition: background 0.3s;
            flex-shrink: 0;
            white-space: nowrap;
        }
        .my-text-box span {
            color: #00ffc3; /* 네온 민트 */
            font-weight: 600;                
        }       
        
        #damage-stats-list {
            margin:8px 0 0 0;
            padding:0;
        }
        
        .rank-li {
            display: flex;
            align-items: center;
            position: relative;
            overflow: hidden;
            gap: 10px;
            padding: 6px 10px;
            color: var(--text-color); 
            font-weight: bold;
            margin-bottom: 3px;
            border-radius: 7px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;

            .rank-sub {
                font-size: 0.7em;
                z-index: 1;
            }
        }
        .rank-1 {
            color: #f3e38a;
        }
        .rank-2 {
            color: #d0d0d0;
        }
        .rank-3 {
            color: #f3d8bd;
        }
        .rank-nonmedal {
            font-weight:bold; 
            margin-right:4px;
            text-align: center; 
            width: 20px;
        }
        .rank-badge {
            display: inline-block;
            min-width: 48px;
            text-align: center;
            background: #445244;
            color: #d0c9f6;
            border-radius: 8px;
            padding: 2px 8px;
            font-size: 0.98em;
            font-weight: 600;
            margin-right: 8px;
            letter-spacing: 0.5px;
            box-sizing: border-box;
            transition: background 0.2s, color 0.2s, border 0.2s;
            border: 2px solid #5a4a80;
        }        
        .rank-badge.me {
            background: #4a2a3a !important;
            color: #ffb6c1 !important;
            border: 2px solid #c85a7c !important;
            font-weight: bold;
        }
        .rank-damage-share-bar {
            position: absolute;
            left: 110px;                /* badge + 여백 */
            top: 86%;
            height: 10%;
            opacity: 0.8;
            z-index: 0;
            pointer-events: none;
            transition: width 0.4s;
        }
        .rank-percent-label{
            margin-left: auto;
            font-size: 0.95em;
            color: var(--text-color);
            z-index: 1;
            position: relative;
        }


        
        /* 카드형 UI */
        .damage-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .damage-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(139, 43, 226, 0.05) 100%);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .damage-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, 
                transparent 30%, 
                rgba(139, 43, 226, 0.1) 50%, 
                transparent 70%);
            transform: rotate(45deg);
            transition: transform 0.6s;
            pointer-events: none;
        }
        
        .damage-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--info-color));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }
        
        .damage-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 32px rgba(139, 43, 226, 0.4), 
                        0 0 40px rgba(139, 43, 226, 0.3),
                        inset 0 0 20px rgba(139, 43, 226, 0.1);
            border-color: rgba(139, 43, 226, 0.6);
        }
        
        .damage-card:hover::after {
            transform: rotate(45deg) translateX(100%);
        }
        
        .damage-card:hover::before {
            transform: scaleX(1);
        }
        
        .damage-card.rank-1 {
            border-color: var(--accent-gold);
            background: linear-gradient(135deg, rgba(255,165,0,0.1) 0%, var(--bg-card) 50%);
            box-shadow: 0 4px 20px rgba(255,165,0,0.2);
        }
        
        .damage-card.rank-1::before {
            background: linear-gradient(90deg, var(--accent-gold), #FFA500);
        }
        
        .damage-card.rank-2 {
            border-color: var(--accent-silver);
            background: linear-gradient(135deg, rgba(183,148,244,0.08) 0%, var(--bg-card) 50%);
            box-shadow: 0 4px 20px rgba(183,148,244,0.2);
        }
        
        .damage-card.rank-2::before {
            background: linear-gradient(90deg, var(--accent-silver), #B8B8B8);
        }
        
        .damage-card.rank-3 {
            border-color: var(--accent-bronze);
            background: linear-gradient(135deg, rgba(246,173,85,0.08) 0%, var(--bg-card) 50%);
            box-shadow: 0 4px 20px rgba(246,173,85,0.2);
        }
        
        .damage-card.rank-3::before {
            background: linear-gradient(90deg, var(--accent-bronze), #A0522D);
        }
        
        .damage-card.me {
            border-color: rgba(0,255,136,0.5);
            box-shadow: 0 0 20px rgba(0,255,136,0.15), inset 0 0 0 2px rgba(0,255,136,0.1);
            background: linear-gradient(135deg, rgba(0,255,136,0.03) 0%, var(--bg-card) 50%);
        }
        
        .damage-card.me:hover {
            box-shadow: 0 0 40px rgba(0,255,136,0.3), inset 0 0 0 2px rgba(0,255,136,0.2);
        }
        
        .damage-card.me::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0,255,136,0.1) 0%, transparent 70%);
            animation: rotate 10s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0;
                transform: scale(0.95);
            }
            to { 
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .card-rank {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 2.2em;
            font-weight: 900;
            opacity: 0.15;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dim));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .card-job {
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), transparent);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            border: 1px solid rgba(0, 217, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .card-me-badge {
            background: linear-gradient(135deg, var(--accent-me), #00CC6F);
            color: var(--bg-color);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0,255,136,0.3), 0 0 20px rgba(0,255,136,0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-shadow: 0 0 4px rgba(0,0,0,0.5);
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 2px 8px rgba(0,255,136,0.3), 0 0 20px rgba(0,255,136,0.3); }
            50% { box-shadow: 0 2px 12px rgba(0,255,136,0.5), 0 0 30px rgba(0,255,136,0.5); }
        }
        
        .card-main-stat {
            text-align: center;
            margin: 20px 0;
        }
        
        .card-dps {
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary-color), var(--accent-me));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .card-dps-label {
            font-size: 0.8em;
            color: var(--text-dim);
            margin-top: 4px;
        }
        
        .card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }
        
        .card-stat {
            text-align: center;
        }
        
        .card-stat-value {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .card-stat-label {
            font-size: 0.75em;
            color: var(--text-dim);
            margin-top: 2px;
        }
        
        .card-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--bg-tertiary);
        }
        
        .card-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, 
                var(--primary-color) 0%, 
                var(--secondary-color) 50%, 
                var(--accent-me) 100%);
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .card-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255,255,255,0.3), 
                transparent);
            animation: shimmer 2s infinite;
        }
        
        /* 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.open {
            display: flex;
        }
        
        .modal-content {
            background: linear-gradient(135deg, var(--bg-soft), var(--bg-card));
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            position: relative;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.2);
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(139, 43, 226, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: rgba(19, 19, 26, 0.95);
            z-index: 10;
            border-radius: 16px 16px 0 0;
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .modal-title {
            font-size: 1.4em;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: 1.5em;
            cursor: pointer;
            transition: color 0.2s;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            color: var(--danger-color);
        }
        
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }
        
        .detail-panel {
            display: none;
        }
        .detail-title {
            display: flex;
            align-items: center;
            position: relative;
            overflow: hidden;
            gap: 10px;
            font-weight: bold;
            margin-bottom: 3px;
            border-radius: 7px;
        }
        .detail-stats {
            display: flex;
            flex-direction: column;
            gap: 7px;
            align-items: flex-start;
            font-size: 0.9em;
        }
        .detail-label {
            color: var(--text-dim);
            font-weight: 600;
            font-size: 0.9em;
            margin-right: 2px;
        }
        .detail-value {
            color: #c0b0fa;
            font-weight: bold;
            font-size: 0.9em;
            margin-right: 10px;
        }
        .detail-dot {
            color: #d84315;
            font-weight: bold;
        }

        .skill-table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
            margin-top: 12px;
            background: none;
            font-size: 0.9em;

            .skill-row {
                position: relative;
                display: grid;
                grid-template-columns: 1.5fr 1.2fr 0.8fr 0.8fr 0.8fr 0.8fr;
                gap: 12px;
                padding: 12px 16px;
                align-items: center;
                font-size: 0.9em;
                cursor: pointer;
                border-bottom: 1px solid var(--border-color);
                transition: background-color 0.2s;
            }
            .skill-row:hover {
                background-color: rgba(255, 255, 255, 0.05);
            }
            .skill-row .bar-bg {
              position: absolute;
              top: 0;
              left: 0;
              bottom: 0;
              background: linear-gradient(90deg, var(--primary-color) 0%, transparent 100%);
              opacity: 0.2;
              z-index: 0;
              pointer-events: none;
            }         
            .skill-row > div {
              position: relative;
              z-index: 1;
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
            }
            .skill-name {
              font-weight: 500;
            }
            .skill-damage {
                font-weight: 500;
                color: var(--text-color);
            }
            .skill-crit, .skill-addhit {
                font-size: 0.85em;
                text-align: center;
                color: var(--text-dim);
            }

            .skill-detail-row {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 16px;
                padding: 0;
                background-color: rgba(0, 0, 0, 0.3);
                font-size: 0.85em;
                color: #ccc;
                box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
                transition: all 0.3s ease;
                overflow: hidden;
                max-height: 0;
                opacity: 0;
            }
            .skill-detail-row.active {
                max-height: 300px;
                opacity: 1;
                padding: 16px 24px;
                margin-bottom: 8px;
            }
            .skill-detail-row > div {
                background: var(--bg-soft);
                padding: 12px;
                border-radius: 6px;
                border: 1px solid var(--border-color);
            }
            .skill-detail-row > div > div:first-child {
                font-weight: 600;
                color: var(--primary-color);
                margin-bottom: 8px;
                padding-bottom: 8px;
                border-bottom: 1px solid var(--border-color);
            }
            .skill-detail-row > div > div:not(:first-child) {
                display: flex;
                justify-content: space-between;
                padding: 4px 0;
                font-size: 0.9em;
            }
            .skill-detail-row > div > div:not(:first-child) span:last-child {
                font-weight: 500;
                color: var(--text-color);
            }
            .hidden {
                display: none !important;
            }   
        }

        .buff-item {
            flex: 0 0 25%; 
            display:flex; 
            align-items: center; 
            justify-content: flex-start; 
            white-space: nowrap; 
            border-radius: 8px 8px;
            border: 1px solid var(--border-color);
            padding: 10px;
            
            .circle {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background-color: #007bff;
                display: inline-block;
                margin-right: 16px;                
            }
        }
        
        .buff-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 217, 255, 0.2);
            border-color: rgba(0, 217, 255, 0.3);
        }
        
        /* 툴팁 스타일 */
        .tooltip {
            position: relative;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            background-color: rgba(0, 0, 0, 0.95);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 9999;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 0.8em;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid rgba(0, 217, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            font-weight: normal;
        }
        
        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* 설정 패널 스타일 */
        #settingsPanel {
            position: fixed;
            top: 0;
            right: 0;
            width: 350px;
            height: 100%;
            background: linear-gradient(135deg, var(--bg-soft), var(--bg-card));
            box-shadow: -4px 0 16px rgba(0, 0, 0, 0.4);
            z-index: 2100;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        #settingsPanel.open {
            transform: translateX(0);
        }
        
        .settings-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .settings-content {
            padding: 20px;
            overflow-y: auto;
            height: calc(100% - 80px);
        }
        
        .setting-item {
            margin-bottom: 20px;
        }
        
        .setting-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .toggle-switch {
            width: 48px;
            height: 24px;
            background: var(--bg-dark);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
            border: 1px solid var(--border-color);
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: var(--text-dim);
            border-radius: 50%;
            transition: transform 0.3s, background 0.3s;
        }
        
        .toggle-switch.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .toggle-switch.active::after {
            transform: translateX(24px);
            background: white;
        }
        
        /* 애니메이션 비활성화 */
        body.no-animation * {
            animation: none !important;
            transition: none !important;
        }
        
        /* Synthwave 테마 */
        body[data-theme="synthwave"] {
            --bg-color:         #0f0814;
            --bg-soft:          #1a0f26;
            --bg-card:          #261438;
            --bg-hover:         #331a4a;
            --text-color:       #f0e0ff;
            --text-dim:         #b8a0d0;
            --border-color:     rgba(255, 0, 128, 0.3);
            --primary-color:    #FF0080;
            --secondary-color:  #00D4FF;
            --success-color:    #00FF88;
            --warning-color:    #FFB800;
            --accent-gold:      #FF1493;
            --accent-silver:    #FF69B4;
            --accent-bronze:    #FF6347;
        }
        
        /* Matrix 테마 */
        body[data-theme="matrix"] {
            --bg-color:         #000000;
            --bg-soft:          #0a0f0a;
            --bg-card:          #0f1a0f;
            --bg-hover:         #142214;
            --text-color:       #00ff00;
            --text-dim:         #008800;
            --border-color:     rgba(0, 255, 0, 0.2);
            --primary-color:    #00ff00;
            --secondary-color:  #00cc00;
            --success-color:    #00ff88;
            --warning-color:    #88ff00;
            --danger-color:     #00ff00;
            --accent-gold:      #00ff00;
            --accent-silver:    #00cc00;
            --accent-bronze:    #009900;
        }
        
        /* 소프트 다크 테마 */
        body[data-theme="soft-dark"] {
            --bg-color:         #1a1a1a;
            --bg-soft:          #242424;
            --bg-card:          #2e2e2e;
            --bg-hover:         #353535;
            --text-color:       #e8e8e8;
            --text-dim:         #a0a0a0;
            --border-color:     rgba(255,255,255,0.1);
            --primary-color:    #64B5F6;
            --danger-color:     #EF5350;
            --success-color:    #66BB6A;
            --warning-color:    #FFA726;
            --info-color:       #AB47BC;
        }
        
        /* 미니멀 다크 테마 */
        body[data-theme="minimal"] {
            --bg-color:         #000000;
            --bg-soft:          #111111;
            --bg-card:          #1a1a1a;
            --bg-hover:         #2a2a2a;
            --text-color:       #ffffff;
            --text-dim:         #888888;
            --border-color:     rgba(255,255,255,0.1);
            --primary-color:    #ffffff;
            --secondary-color:  #cccccc;
            --danger-color:     #ff4444;
            --success-color:    #44ff44;
            --warning-color:    #ffaa44;
            --accent-gold:      #ffffff;
            --accent-silver:    #cccccc;
            --accent-bronze:    #999999;
        }
        
        /* 버튼 그룹 및 드롭다운 */
        .btn-group {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            min-width: 180px;
            background: var(--bg-soft);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            margin-top: 4px;
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 10px 16px;
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        .dropdown-item:hover {
            background: var(--bg-hover);
            color: var(--primary-color);
        }
        
        .dropdown-item:first-child {
            border-radius: 8px 8px 0 0;
        }
        
        .dropdown-item:last-child {
            border-radius: 0 0 8px 8px;
        }
        
        /* 리스트 뷰 스타일 */
        .damage-list-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 20px;
            padding: 0 5px;
        }
        
        .damage-list-item {
            display: grid;
            grid-template-columns: 40px 150px 1fr 120px 120px 80px 80px 80px 80px;
            gap: 12px;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.2s ease;
            position: relative;
            cursor: pointer;
        }
        
        .damage-list-item:hover {
            background: var(--bg-hover);
            transform: translateX(4px);
            border-color: rgba(0, 217, 255, 0.3);
            box-shadow: 0 2px 8px rgba(0, 217, 255, 0.1);
        }
        
        .damage-list-item.rank-1 {
            border-left: 3px solid var(--accent-gold);
        }
        
        .damage-list-item.rank-2 {
            border-left: 3px solid var(--accent-silver);
        }
        
        .damage-list-item.rank-3 {
            border-left: 3px solid var(--accent-bronze);
        }
        
        .damage-list-item.me {
            background: linear-gradient(90deg, rgba(0,255,136,0.05) 0%, var(--bg-card) 100%);
            border-color: rgba(0,255,136,0.3);
        }
        
        .list-rank {
            font-size: 1.2em;
            font-weight: 700;
            text-align: center;
            color: var(--text-dim);
        }
        
        .list-rank.rank-1 { color: var(--accent-gold); }
        .list-rank.rank-2 { color: var(--accent-silver); }
        .list-rank.rank-3 { color: var(--accent-bronze); }
        
        .list-job {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .list-dps {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .list-damage, .list-share {
            font-weight: 600;
            color: var(--text-color);
        }
        
        .list-stat {
            text-align: center;
            font-size: 0.9em;
            color: var(--text-dim);
        }
        
        .list-damage-bar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            background: linear-gradient(90deg, var(--primary-color) 0%, transparent 100%);
            opacity: 0.1;
            pointer-events: none;
            border-radius: 8px 0 0 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="panel">
            <div class="options-bar"> 
                <div style="display: flex; gap: 6px; align-items: center;">
                    <button class="btn tooltip" id="connectBtn">
                        <i class="fas fa-plug"></i>
                        <span id="connectSym" class="status-indicator"></span>
                        <span class="tooltip-text">WebSocket 서버 연결</span>
                    </button>
                    <button id="clearBtn" class="btn tooltip">
                        <i class="fas fa-trash"></i>
                        <span class="tooltip-text">데이터 초기화</span>
                    </button>
                    <button id="saveAllBtn" class="btn tooltip">
                        <i class="fas fa-save"></i>
                        <span class="tooltip-text">데이터 저장</span>
                    </button>
                    <button id="loadAllBtn" class="btn tooltip">
                        <i class="fas fa-folder-open"></i>
                        <span class="tooltip-text">데이터 불러오기</span>
                    </button>
                    <div class="btn-group">
                        <button id="exportBtn" class="btn tooltip">
                            <i class="fas fa-file-export"></i>
                            <span class="tooltip-text">내보내기</span>
                        </button>
                        <div id="exportMenu" class="dropdown-menu" style="display: none;">
                            <button class="dropdown-item" onclick="exportScreenshot()">
                                <i class="fas fa-camera"></i> 스크린샷
                            </button>
                            <button class="dropdown-item" onclick="exportCSV()">
                                <i class="fas fa-file-csv"></i> CSV 다운로드
                            </button>
                            <button class="dropdown-item" onclick="copyToClipboard()">
                                <i class="fas fa-clipboard"></i> 클립보드 복사
                            </button>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px; align-items: center;">
                    <label for="calcmodechkbox" style="display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-calculator"></i>
                        <select id="calcmodechkbox" class="combobox" name="calcmode">
                            <option value="all">모두</option>
                            <option value="highest_hp">최대 HP</option>
                            <option value="most_attacked">딜 집중</option>
                        </select>
                    </label>
                    <label class="tooltip" style="display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-bullseye"></i>
                        <input type="checkbox" id="singleModeCheckbox">
                        <span class="tooltip-text">허수아비 모드</span>
                    </label>
                </div>
                
                <button id="settingsBtn" class="btn tooltip" style="margin-left: auto;">
                    <i class="fas fa-cog"></i>
                    <span class="tooltip-text">설정</span>
                </button>
            </div>
        </div>
        
        <!-- 실시간 DPS 차트 -->
        <div class="panel" id="chartPanel" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0; font-size: 1.1em; color: var(--text-color);">
                    <i class="fas fa-chart-area" style="color: var(--primary-color);"></i> 실시간 DPS 추이
                </h3>
                <div style="display: flex; gap: 6px; align-items: center;">
                    <button class="btn tooltip" onclick="if(dpsChart) dpsChart.resetZoom();">
                        <i class="fas fa-home"></i>
                        <span class="tooltip-text">차트 위치 초기화</span>
                    </button>
                    <span style="font-size: 0.8em; color: var(--text-dim);">
                        <i class="fas fa-info-circle"></i> 드래그: 좌우 이동
                    </span>
                </div>
            </div>
            <div style="position: relative; height: 200px; background: var(--bg-soft); border-radius: 8px; padding: 10px;">
                <canvas id="realtimeDPSChart" style="max-height: 180px;"></canvas>
            </div>
        </div>
        
        <div class="panel">
            <div class="meter-wrapper">
                <div id="runtime-display" class="my-text-box tooltip">
                    <i class="fas fa-clock"></i>
                    전투 시간: <span id="runtime-text">0.00초</span>
                    <span class="tooltip-text">전투가 진행된 총 시간</span>
                </div>
                <div id="runtime-total" class="my-text-box tooltip">
                    <i class="fas fa-fire"></i>
                    전체 딜량: <span id="total-text">0</span>
                    <span class="tooltip-text">파티원 전체가 입힌 총 데미지</span>
                </div>
                <div id="runtime-total" class="my-text-box tooltip">
                    <i class="fas fa-chart-line"></i>
                    전체 DPS: <span id="total-dps-text">0</span>
                    <span class="tooltip-text">파티원 전체의 초당 데미지</span>
                </div>
            </div>
            <hr class="divider">
            <div id="damage-stats-list" class="damage-cards-container"></div>
        </div>
        <div id="detail-panel" class="panel detail-panel">
            <div id="detail-title-panel"  style="padding: 8px 0px;"></div>
            <hr class="divider">
            <div id="stat-detail-panel"  style="padding: 8px 12px;">
                <div class="detail-stats">
                    <div class="meter-wrapper">
                        <div class="my-text-box">크리 확률:<span class="detail-value">0%</span></div>
                        <div class="my-text-box">추가타 확률:<span class="detail-value">0%</span></div>
                        <div class="my-text-box">평균 공증:<span class="detail-value">0%</span></div>
                        <div class="my-text-box">평균 피증:<span class="detail-value">0%</span></div>
                    </div>
                    <div class="my-text-box" style="display: block; width: 100%;">
                        <div id="buff-radio-groups" style="display: flex; align-items: center; gap:12px;">
                            <div class="btn">전체</div>
                            <div class="btn">룬</div>
                            <div class="btn">스킬</div>
                            <div class="btn">시너지</div>
                            <div class="btn">적</div>
                            <div class="btn">펫</div>
                            <div style="color: var(--text-dim)">(버프 가동률 / 최대 스택)</div>
                        </div>
                        <div class="buff-list" style="display: flex; align-items: flex-start; flex-wrap: wrap; gap:12px; margin:20px 0px">
                            
                        </div>
                        <div class="buff-list" style="display: flex; align-items: flex-start; gap:12px; margin-top:10px">
                            
                        </div>
                    </div>
                </div>
            </div>
            <hr class="divider">
            <div id="skill-detail-panel" style="padding: 0px 6px; font-size: 1.13em"></div>
        </div>
    </div>
    <script>
        const wsUrl = "ws://localhost:8080";
        let ws;

        let damageDB  = {0:{0:{"":{}}}}
        let damageDB2 = {0:{0:{"":{}}}}
        let buffDB = {};
        let selfID = 0;
        let enemyData = {}
        let userData = {}
        let hitTime = {};
        let userTmpData = {}

        let bossMode = "all";
        let singleMode = false;
        let render_timeout = null;
        let buffVisibleTypes = {}

        let skillDetailOpened = {};        
        let selectedDetailUserId = null;
        const selectedDetailSkillName = {};
        let dpsChart = null;
        let dpsChartData = [];
        let maxDataPoints = 120; // 2분 데이터로 축소 (성능 개선)
        let chartInitialized = false;
        let chartUpdateTimeout = null;
        let isTabActive = true;
        let viewMode = 'card'; // 'card' or 'list'
        
        // 자동 초기화 관련 변수
        let lastDataTime = Date.now();
        let autoResetInterval = null;
        let autoResetTimeout = 60000; // 1분
        
        // DPS 차트 초기화
        function initDPSChart() {
            if (chartInitialized && dpsChart) {
                console.log('차트가 이미 초기화되어 있습니다');
                return;
            }
            
            const canvas = document.getElementById('realtimeDPSChart');
            if (!canvas) {
                console.error('차트 캔버스를 찾을 수 없습니다');
                // DOM이 완전히 로드되지 않았을 수 있으므로 다시 시도
                if (document.readyState !== 'complete') {
                    setTimeout(initDPSChart, 100);
                }
                return;
            }
            
            // 차트 패널이 표시되어 있는지 확인
            const chartPanel = document.getElementById('chartPanel');
            if (!chartPanel || chartPanel.style.display === 'none') {
                console.log('차트 패널이 숨겨져 있어 초기화를 건너뜁니다');
                return;
            }
            
            // Chart.js가 로드되었는지 확인
            if (typeof Chart === 'undefined') {
                console.error('Chart.js가 아직 로드되지 않았습니다');
                setTimeout(initDPSChart, 100);
                return;
            }
            
            try {
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('Canvas context를 가져올 수 없습니다');
                    return;
                }
                
                dpsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#e0e0e0',
                                font: {
                                    size: 11
                                },
                                usePointStyle: true,
                                padding: 10
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' DPS';
                                }
                            }
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: false
                                },
                                pinch: {
                                    enabled: false
                                },
                                mode: 'x'
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                                modifierKey: null
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#999',
                                font: {
                                    size: 10
                                },
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            display: true,
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#999',
                                font: {
                                    size: 10
                                },
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
                chartInitialized = true;
                console.log('차트 초기화 성공');
                
                // 초기화 성공 후 빈 차트 표시
                dpsChart.update();
            } catch (error) {
                console.error('차트 초기화 실패:', error);
                chartInitialized = false;
                dpsChart = null;
                // 재시도
                setTimeout(initDPSChart, 500);
            }
        }
        
        // DPS 차트 업데이트
        function updateDPSChart() {
            const sorted = calcSortedItems();
            
            // 데이터가 없으면 차트를 초기화하지 않음
            if (sorted.length === 0) {
                return;
            }
            
            // 차트가 아직 초기화되지 않았고 데이터가 있으면 초기화
            if (!dpsChart || !chartInitialized) {
                console.log('첫 데이터 수신, 차트 초기화 시작...');
                // 차트 패널 표시
                const chartPanel = document.getElementById('chartPanel');
                if (chartPanel) {
                    chartPanel.style.display = 'block';
                }
                initDPSChart();
                // 초기화 후 다음 업데이트에서 데이터 표시
                setTimeout(() => updateDPSChart(), 100);
                return;
            }
            const currentTime = new Date().toLocaleTimeString('ko-KR', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            // 새로운 레이블 추가
            if (dpsChart.data.labels.length >= maxDataPoints) {
                dpsChart.data.labels.shift();
            }
            dpsChart.data.labels.push(currentTime);
            
            // 데이터셋 업데이트 또는 생성
            const colors = ['#FF6B6B', '#4D9DE0', '#7AE582', '#FFD93D', '#A05ED9', '#E65A9C'];
            const top5 = sorted.slice(0, 5);
            
            // 기존 데이터셋 업데이트
            dpsChart.data.datasets = top5.map(([user_id, item], idx) => {
                const total = item[""].all.total_damage || 0;
                const dps = Math.floor(total / (getRuntimeSec() + 1));
                const jobName = userData[user_id] ? userData[user_id].job : user_id;
                const isSelf = selfID == user_id;
                
                // 기존 데이터셋 찾기
                let dataset = dpsChart.data.datasets.find(ds => ds.label === jobName);
                if (!dataset) {
                    dataset = {
                        label: jobName,
                        data: new Array(dpsChart.data.labels.length - 1).fill(0),
                        borderColor: isSelf ? '#00ff88' : colors[idx % colors.length],
                        backgroundColor: isSelf ? 'rgba(0, 255, 136, 0.1)' : `rgba(${parseInt(colors[idx % colors.length].slice(1,3),16)}, ${parseInt(colors[idx % colors.length].slice(3,5),16)}, ${parseInt(colors[idx % colors.length].slice(5,7),16)}, 0.1)`,
                        borderWidth: isSelf ? 3 : 2,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 5
                    };
                }
                
                // 데이터 배열 길이 조정
                if (dataset.data.length >= maxDataPoints) {
                    dataset.data.shift();
                }
                dataset.data.push(dps);
                
                return dataset;
            });
            
            dpsChart.update('none');
        }
        
        (function(){
            document.getElementById('damage-stats-list').addEventListener('click', e => {
                const card = e.target.closest('.damage-card');
                if (!card) return;
                
                selectedDetailUserId = card.dataset.userId;
                showDetailModal(card.dataset.userId);
            });
            document.getElementById('detail-panel').addEventListener('click', e => {
                const row = e.target.closest('.skill-row');
                if (!row) return;

                const skillId = row.dataset.skillId;
                const detail = document.getElementById(skillId);
                if (detail && detail.classList.contains('skill-detail-row')) {
                    const isActive = detail.classList.contains('active');
                    if (isActive) {
                        detail.classList.remove('active');
                        skillDetailOpened[skillId] = false;
                        selectedDetailSkillName[selectedDetailUserId] = null;
                    } else {
                        detail.classList.add('active');
                        skillDetailOpened[skillId] = true;
                        selectedDetailSkillName[selectedDetailUserId] = detail.dataset.skill;
                    }
                    showDetailModal(selectedDetailUserId);
                }
            });
        })()

        function getTargetID(){
            if (bossMode == "all"){
                return 0;
            }
            else if (bossMode == "highest_hp") {
                return enemyData.max_hp_tid || 0;
            }
            else if(bossMode == "most_attacked"){
                return enemyData.most_attacked_tid || 0;
            }
            else{
                return enemyData.last_attacked_tid || 0;
            }
        }
        function getRuntimeSec(){
            const tid = getTargetID();
            return hitTime[tid]
                        ? (hitTime[tid].end - hitTime[tid].start)
                        : 0;                    
        }
        function getTotalDamage(isSingle){
            const sorted = calcSortedItems()
            if (sorted.length === 0) {
                return 0;
            }
            const totalSum = sorted.reduce((sum, [uid,stat]) => sum + (stat[""].all.total_damage || 0), 0);
            return totalSum;
        }
        function calcAddHitPercent(item) {
            if (item == null) return 0;
            const nAddHit = item.normal.addhit_count + item.special.addhit_count;
            const nAll = item.normal.total_count + item.special.total_count;
            return nAddHit ? (nAddHit / (nAll-nAddHit) * 100).toFixed(2) : 0;
        }
        function calcCritHitPercent(item){
            if (item == null) return 0;
            const nCrit = item.normal.crit_count + item.special.crit_count;
            const nAll = item.normal.total_count + item.special.total_count;
            return nCrit ? (nCrit / nAll * 100).toFixed(2) : 0;
        }
        function divideForDis(numerator, denominator){
            return denominator > 0 ? (numerator / denominator).toFixed(2) : 0;
        }
        function calcPercent(numerator, denominator){
            return denominator > 0 ? (numerator / denominator * 100).toFixed(2) : 0;
        }

        function showDetailModal(uid) {
            const modal = document.getElementById('detailModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalTitle');
            
            const tid = getTargetID();
            const db = singleMode ? damageDB2 : damageDB;
            
            if (!db[uid] || !db[uid][tid]) return;
            
            const jobName = userData[uid] ? userData[uid].job : uid;
            modalTitle.textContent = `${jobName} 상세 정보`;
            
            // 모달 내용 구성
            modalBody.innerHTML = '';
            
            // 통계 섹션
            const statsSection = document.createElement('div');
            statsSection.innerHTML = '<h3 style="margin-bottom: 16px;">전투 통계</h3>';
            renderDetailStats(uid, statsSection);
            modalBody.appendChild(statsSection);
            
            // 버프 섹션
            const buffSection = document.createElement('div');
            buffSection.style.marginTop = '24px';
            buffSection.innerHTML = '<h3 style="margin-bottom: 16px;">버프 가동률</h3>';
            renderDetailBuffs(uid, buffSection);
            modalBody.appendChild(buffSection);
            
            // 스킬 섹션
            const skillSection = document.createElement('div');
            skillSection.style.marginTop = '24px';
            skillSection.innerHTML = `
                <div style="margin-bottom: 16px;">
                    <h3 style="margin: 0 0 12px 0;">스킬별 데미지</h3>
                    <div style="display: grid; grid-template-columns: 1.5fr 1.2fr 0.8fr 0.8fr 0.8fr 0.8fr; gap: 12px; font-size: 0.85em; color: var(--text-dim); padding: 12px 16px; background: var(--bg-soft); border-radius: 8px; margin-bottom: 8px;">
                        <div style="font-weight: 600;">스킬명</div>
                        <div style="text-align: left; font-weight: 600;">데미지 (점유율)</div>
                        <div style="text-align: center;" class="tooltip">
                            평균 공증
                            <span class="tooltip-text">스킬 사용 시 평균 공격력 증가</span>
                        </div>
                        <div style="text-align: center;" class="tooltip">
                            평균 피증
                            <span class="tooltip-text">스킬 사용 시 평균 피해 증가</span>
                        </div>
                        <div style="text-align: center;" class="tooltip">
                            크리율
                            <span class="tooltip-text">해당 스킬의 크리티컬 확률</span>
                        </div>
                        <div style="text-align: center;" class="tooltip">
                            추가타율
                            <span class="tooltip-text">해당 스킬의 추가타 발생률</span>
                        </div>
                    </div>
                </div>
            `;
            renderSkillDetail(uid, skillSection);
            modalBody.appendChild(skillSection);
            
            // 스킬 클릭 이벤트 추가
            setTimeout(() => {
                skillSection.querySelectorAll('.skill-row').forEach(row => {
                    row.addEventListener('click', function() {
                        const skillId = this.dataset.skillId;
                        const detailRow = document.getElementById(skillId);
                        if (detailRow) {
                            const isActive = detailRow.classList.contains('active');
                            if (isActive) {
                                detailRow.classList.remove('active');
                                skillDetailOpened[skillId] = false;
                                selectedDetailSkillName[uid] = null;
                            } else {
                                detailRow.classList.add('active');
                                skillDetailOpened[skillId] = true;
                                selectedDetailSkillName[uid] = detailRow.dataset.skill;
                            }
                            renderDetailStats(uid, document.querySelector('.card-stats').parentElement);
                            renderDetailBuffs(uid, document.querySelector('.buff-stats').parentElement);
                        }
                    });
                });
            }, 100);
            
            modal.classList.add('open');
        }
        
        function renderDetailStats(uid, container) {
            const tid = getTargetID();
            const skill = selectedDetailSkillName[uid] ?? "";
            const db = singleMode ? damageDB2[uid][tid][skill] : damageDB[uid][tid][skill];
            
            const critRate = calcCritHitPercent(db);
            const addhitRate = calcAddHitPercent(db);
            const atkbuff = divideForDis(db.buff.total_atk, db.buff.total_count);
            const dmgbuff = divideForDis(db.buff.total_dmg, db.buff.total_count);
            
            const statsHtml = `
                <div class="card-stats" style="background: var(--bg-soft); padding: 16px; border-radius: 8px;">
                    <div class="card-stat">
                        <div class="card-stat-value">${critRate}%</div>
                        <div class="card-stat-label">크리티컬 확률</div>
                    </div>
                    <div class="card-stat">
                        <div class="card-stat-value">${addhitRate}%</div>
                        <div class="card-stat-label">추가타 확률</div>
                    </div>
                    <div class="card-stat">
                        <div class="card-stat-value">${atkbuff}</div>
                        <div class="card-stat-label">평균 공격력 증가</div>
                    </div>
                    <div class="card-stat">
                        <div class="card-stat-value">${dmgbuff}</div>
                        <div class="card-stat-label">평균 피해 증가</div>
                    </div>
                </div>
            `;
            
            container.innerHTML += statsHtml;
        }
        
        function renderDetailBuffs(uid, container) {
            const tid = getTargetID();
            const skill = selectedDetailSkillName[uid] ?? "";
            const db = singleMode ? damageDB2[uid][tid][skill] : damageDB[uid][tid][skill];
            const buffs = buffDB[uid] ? buffDB[uid][tid][skill] : {};
            
            const types = {"룬":1, "스킬":11, "시너지":12, "적":21, "펫":31};
            const colors = {1:"E68A2E", 11:"2E7DD9", 12:"36CC6D", 21:"A05ED9", 31:"E65A9C"};
            const typeNames = {1:"룬", 11:"스킬", 12:"시너지", 21:"적", 31:"펫"};
            
            // 버프를 타입별로 그룹화
            const buffsByType = {};
            for (const [key, value] of Object.entries(buffs)) {
                const type = value.type;
                if (!buffsByType[type]) buffsByType[type] = [];
                const uptime = calcPercent(value.total_stack/value.max_stack, db.normal.total_count + db.special.total_count);
                buffsByType[type].push({name: key, uptime, maxStack: value.max_stack, color: colors[type]});
            }
            
            // 탭 네비게이션 생성
            let tabsHtml = '<div style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 8px;">';
            tabsHtml += '<button class="buff-tab active" data-type="all" style="padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px 4px 0 0; cursor: pointer;">전체</button>';
            
            for (const [typeCode, typeName] of Object.entries(typeNames)) {
                if (buffsByType[typeCode] && buffsByType[typeCode].length > 0) {
                    tabsHtml += `<button class="buff-tab" data-type="${typeCode}" style="padding: 8px 16px; background: var(--bg-soft); color: var(--text-color); border: none; border-radius: 4px 4px 0 0; cursor: pointer;">${typeName} (${buffsByType[typeCode].length})</button>`;
                }
            }
            tabsHtml += '</div>';
            
            // 버프 컨테이너
            let buffHtml = '<div class="buff-container" style="max-height: 300px; overflow-y: auto; background: var(--bg-soft); padding: 16px; border-radius: 8px;">';
            buffHtml += '<div class="buff-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;">';
            
            // 모든 버프 표시 (초기 상태)
            for (const [typeCode, buffList] of Object.entries(buffsByType)) {
                buffList.sort((a, b) => parseFloat(b.uptime) - parseFloat(a.uptime)); // 가동률 순으로 정렬
                buffList.forEach(buff => {
                    buffHtml += `
                        <div class="buff-item" data-type="${typeCode}" style="display: flex; align-items: center; padding: 12px; background: var(--bg-dark); border-radius: 6px; border: 1px solid var(--border-color);">
                            <div class="circle" style="width: 12px; height: 12px; border-radius: 50%; background:#${buff.color}; margin-right: 12px; flex-shrink: 0;"></div>
                            <div style="flex: 1; overflow: hidden;">
                                <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${buff.name}</div>
                                <div style="font-size: 0.85em; color: var(--text-dim);">가동률: ${buff.uptime}% / 최대: ${buff.maxStack}</div>
                            </div>
                            <div style="margin-left: 12px; font-weight: 600; color: #${buff.color};">${buff.uptime}%</div>
                        </div>
                    `;
                });
            }
            
            buffHtml += '</div></div>';
            
            container.innerHTML += tabsHtml + buffHtml;
            
            // 탭 클릭 이벤트
            setTimeout(() => {
                const tabs = container.querySelectorAll('.buff-tab');
                const buffItems = container.querySelectorAll('.buff-item');
                
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        // 탭 활성화 상태 변경
                        tabs.forEach(t => {
                            t.style.background = 'var(--bg-soft)';
                            t.style.color = 'var(--text-color)';
                            t.classList.remove('active');
                        });
                        tab.style.background = 'var(--primary-color)';
                        tab.style.color = 'white';
                        tab.classList.add('active');
                        
                        // 버프 필터링
                        const selectedType = tab.dataset.type;
                        buffItems.forEach(item => {
                            if (selectedType === 'all' || item.dataset.type === selectedType) {
                                item.style.display = 'flex';
                            } else {
                                item.style.display = 'none';
                            }
                        });
                    });
                });
            }, 100);
        }
        
        function showDetail(uid) {
            showDetailModal(uid);
        }
        function renderDetailTitle(uid){
            const detailDiv = document.getElementById('detail-title-panel');
            while (detailDiv.firstChild) detailDiv.removeChild(detailDiv.firstChild);

            const sorted = calcSortedItems()
            const totalSum = sorted.reduce((sum, [uid,stat]) => sum + (stat[""].all.total_damage || 0), 0);

            sorted.forEach(([user_id, item], idx) => {
                    if(user_id != uid) return;

                    const stat = item[""];

                    const total = stat.all.total_damage || 0;
                    const critRate   = calcCritHitPercent(stat);
                    const addhitRate = calcAddHitPercent(stat);
                    const atkbuff    = divideForDis(stat.buff.total_atk, stat.buff.total_count);
                    const dmgbuff    = divideForDis(stat.buff.total_dmg, stat.buff.total_count);
                    const dps        = Math.floor(total/(getRuntimeSec()+1));
                    const totalRate = sorted.length === 1 ? 1 : totalSum > 0 ? total / totalSum : 0
                    const jobName =  userData[user_id] ? userData[user_id].job : user_id;
                    const isSelf = selfID == user_id;

                    const li = rankItem(idx, isSelf, jobName, total, totalRate, dps, critRate, addhitRate, atkbuff, dmgbuff);
                    detailDiv.appendChild(li);
                });
        }
        function renderDetail(uid) {
            const tid = getTargetID();
            const skill = selectedDetailSkillName[uid] ?? "";
            const db = singleMode ? damageDB2[uid][tid][skill] : damageDB[uid][tid][skill]; 
            
            const rank = calcSortedItems().findIndex(([id, item]) => id === uid);
            const critRate  = calcCritHitPercent(db);
            const addhitRate = calcAddHitPercent(db);
            const atkbuff = divideForDis(db.buff.total_atk, db.buff.total_count);
            const dmgbuff = divideForDis(db.buff.total_dmg, db.buff.total_count);
            
            // 모든 detail-value span을 가져오기
            const values = document.querySelectorAll('#stat-detail-panel .detail-value');
            values[0].textContent = `${critRate}%`; 
            values[1].textContent = `${addhitRate}%`; 
            values[2].textContent = `${atkbuff}`;
            values[3].textContent = `${dmgbuff}`;
            

            const buffList = document.querySelectorAll('#stat-detail-panel .buff-list')[0];
            buffList.innerHTML = '';

            const buffs = buffDB[uid] ? buffDB[uid][tid][""] : {}
            const types = {"룬":1, "스킬":11, "시너지":12, "적":21, "펫":31};
            const colors = {1:"E68A2E", 11:"2E7DD9", 12:"36CC6D", 21:"A05ED9", 31:"E65A9C"};
            for (const [buffTypeName, buffTypeCode] of Object.entries(types)) 
            {
                if (buffVisibleTypes[buffTypeName] != true) continue;

                buffList.innerHTML += Object.entries(buffs)
                    .filter(([key, v])=>v.type == buffTypeCode).map((
                    [key, value])=>`
                        <div class="buff-item">
                            <div class="circle" style="background:#${colors[buffTypeCode]};""></div>
                            ${key}&nbsp;
                            <span class="detail-value">(${calcPercent(value.total_stack/value.max_stack, db.normal.total_count + db.special.total_count)}% / ${value.max_stack})</span>
                        </div>`)
                    .join("")
            }

            if (userTmpData){
                const buffList = document.querySelectorAll('#stat-detail-panel .buff-list')[1];
 
                shortBuffHtml2 = Object.entries(userTmpData[uid].buff).map(([key, value])=>`<span class="detail-value">${key}(${value.buff_stack})</span>`).join("")
                buffList.innerHTML = `
                    <div class="my-text-box" style="display: flex; align-items: center; width: 100%;">
                        <span class="detail-label" style="margin-right: 8px;">버프:</span>
                        <div style="display: flex; flex-wrap: wrap; gap: 4px; flex: 1;">
                            ${shortBuffHtml2}
                        </div>
                    </div>
                `
            }
        }
        function renderSkillDetail(uid, container) {
            if (!container) {
                container = document.getElementById('skill-detail-panel');
            }

            const targetID = getTargetID();
            const db = singleMode  ? damageDB2[uid][targetID] : damageDB[uid][targetID]; 

            // 스킬별 딜량 집계
            const skillRows = [];
            let total = 0;
            for (const skill in db) {
                if (skill == "") continue;
                const skillObj = db[skill];
                const dmg = skillObj ? skillObj.all.total_damage || 0 : 0;
                if (dmg > 0) {
                    const normal = skillObj.normal;
                    const dot = skillObj.dot;
                    const special = skillObj.special;
                    const detail = {
                        total: skillObj.all.total_damage,
                        crit: calcCritHitPercent(skillObj),
                        addhit: calcAddHitPercent(skillObj),
                        atk: divideForDis(skillObj.buff.total_atk, skillObj.buff.total_count),
                        dmg: divideForDis(skillObj.buff.total_dmg, skillObj.buff.total_count),
                    }
                    skillRows.push({ skill, dmg, detail, normal, dot, special });
                    total += dmg;
                }
            }
            if (skillRows.length === 0) {
                return;
            }
            skillRows.sort((a, b) => b.dmg - a.dmg);

            let table = `<div class="skill-table">`;
            skillRows.forEach((row, idx) => {
                const percent = calcPercent(row.dmg, total);
                const id = `skill_${uid}_${row.skill.replace(/[^\w가-힣]/g, '_')}`;
                table += `
                <div class="skill-row" data-skill-id="${id}">
                    <div class="bar-bg" style="width: ${percent}%;"></div>
                    <div class="skill-name" title="${row.skill}">${row.skill}</div>
                    <div class="skill-damage">${row.dmg.toLocaleString()} (${percent}%)</div>
                    <div class="skill-crit">${row.detail.atk}%</div>
                    <div class="skill-crit">${row.detail.dmg}%</div>
                    <div class="skill-crit">${row.detail.crit}%</div>
                    <div class="skill-addhit">${row.detail.addhit}%</div>
                </div>
                <div id="${id}" data-skill="${row.skill}" class="skill-detail-row${skillDetailOpened[id] ? ' active' : ''}">
                    <div>
                        <div>일반 데미지</div>
                        <div><span>타수</span><span>${row.normal.total_count.toLocaleString()}</span></div>
                        <div><span>총합</span><span>${row.normal.total_damage.toLocaleString()} (${calcPercent(row.normal.total_damage,row.detail.total)}%)</span></div>
                        <div><span>최대</span><span>${row.normal.max_damage.toLocaleString()}</span></div>
                        <div><span>최소</span><span>${row.normal.min_damage.toLocaleString()}</span></div>
                        <div><span>강타율</span><span>${calcPercent(row.normal.power_count, row.normal.total_count)}%</span></div>
                        <div><span>연타율</span><span>${calcPercent(row.normal.fast_count, row.normal.total_count)}%</span></div>
                        <div><span>치명타율</span><span>${calcPercent(row.normal.crit_count, row.normal.total_count)}%</span></div>
                    </div>
                    <div>
                        <div>도트 데미지</div>
                        <div><span>타수</span><span>${row.dot.total_count.toLocaleString()}</span></div>
                        <div><span>총합</span><span>${row.dot.total_damage.toLocaleString()} (${calcPercent(row.dot.total_damage,row.detail.total)}%)</span></div>
                        <div><span>최대</span><span>${row.dot.max_damage.toLocaleString()}</span></div>
                        <div><span>최소</span><span>${row.dot.min_damage.toLocaleString()}</span></div>
                        <div><span>강타율</span><span>${calcPercent(row.dot.power_count, row.dot.total_count)}%</span></div>
                        <div><span>연타율</span><span>${calcPercent(row.dot.fast_count, row.dot.total_count)}%</span></div>
                        <div><span>치명타</span><span>${row.dot.crit_count.toLocaleString()}</span></div>
                    </div>
                    <div>
                        <div>특수 데미지</div>
                        <div><span>타수</span><span>${row.special.total_count.toLocaleString()}</span></div>
                        <div><span>총합</span><span>${row.special.total_damage.toLocaleString()} (${calcPercent(row.special.total_damage,row.detail.total)}%)</span></div>
                        <div><span>최대</span><span>${row.special.max_damage.toLocaleString()}</span></div>
                        <div><span>최소</span><span>${row.special.min_damage.toLocaleString()}</span></div>
                        <div><span>강타율</span><span>${calcPercent(row.special.power_count,row.special.total_count)}%</span></div>
                        <div><span>연타율</span><span>${calcPercent(row.special.fast_count,row.special.total_count)}%</span></div>
                        <div><span>치명타율</span><span>${calcPercent(row.special.crit_count,row.special.total_count)}%</span></div>
                    </div>
                </div>
                `;
            });
            table += `</div>`;

            if (container) {
                container.innerHTML = table;
            } else {
                detailDiv.innerHTML = table;
            }
        }

        function clearDetails() {
            selectedDetailUserId = null;
            const detailDiv = document.getElementById('detail-panel');
            detailDiv.classList.remove('visible');
        }

        function rankItem(rank, isSelf, jobName, total, totalRate, dps, critRate, addhitRate, atk, dmg){
            const li = document.createElement('li');
            li.className = 'rank-li';

            if (rank === 0) li.classList.add('rank-1');
            else if (rank === 1) li.classList.add('rank-2');
            else if (rank === 2) li.classList.add('rank-3');
            
            const badge = document.createElement('span');
            badge.className = 'rank-badge' + (isSelf ? ' me' : '');
            badge.textContent = jobName;
            const totalSpan = document.createElement('span');
            totalSpan.className = 'rank-total';
            totalSpan.textContent = `총합: ${total.toLocaleString()}`;
            const dpsSpan = document.createElement('span');
            dpsSpan.className = 'rank-dps';
            dpsSpan.textContent = `DPS: ${dps.toLocaleString()}`;
            const critSpan = document.createElement('span');
            critSpan.className = 'rank-sub';
            critSpan.textContent = `치명타: ${critRate}%`;
            const addhitSpan = document.createElement('span');
            addhitSpan.className = 'rank-sub';
            addhitSpan.textContent = `추가타: ${addhitRate}%`;
            const atkSpan = document.createElement('span');
            atkSpan.className = 'rank-sub';
            atkSpan.textContent = `공증: ${atk}`;
            const dmgSpan = document.createElement('span');
            dmgSpan.className = 'rank-sub';
            dmgSpan.textContent = `피증: ${dmg}`;

            // 퍼센트 라벨(선택)
            const percentLabel = document.createElement('span');
            percentLabel.className = "rank-percent-label";
            // 행이 1개뿐이면 무조건 100%로 표기
            percentLabel.textContent = (totalRate*100).toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1}) + '%';

            // 순위
            const rankNum = document.createElement('span');
            rankNum.className = 'rank-nonmedal';
            rankNum.textContent = (rank + 1).toString().padStart(1, '0');
            li.appendChild(rankNum);

            // === 행 전체 배경 그래프 추가 ===
            const barColor = rank === 0 ? '#bfa642'
               : rank === 1 ? '#8e8e8e'  
               : rank === 2 ? '#c07e47' 
               : '#5a7391'; 
            const bar = document.createElement('div');
            bar.classList.add("rank-damage-share-bar");
            bar.style.background = barColor;
            bar.style.width = ((document.body.offsetWidth-232) * totalRate) + 'px'; //실제크기기반으로 하면 깜빡임 현상 있음

            badge.style.zIndex = '1';
            totalSpan.style.zIndex = '1';
            totalSpan.style.fontWeight = 'bold';
            dpsSpan.style.zIndex = '1';
            dpsSpan.style.fontWeight = 'bold';

            li.appendChild(bar);
            li.appendChild(badge);
            li.appendChild(totalSpan);
            li.appendChild(dpsSpan);
            li.appendChild(critSpan);
            li.appendChild(addhitSpan);
            li.appendChild(atkSpan);
            li.appendChild(dmgSpan);
            li.appendChild(percentLabel);

            return li;
        }

        // 데미지 순위 표시 함수
        function renderDamageRanks() {
            const statsList = document.getElementById('damage-stats-list');
            while (statsList.firstChild) statsList.removeChild(statsList.firstChild);

            const sorted = calcSortedItems()
            
            // 데이터가 없을 때 빈 상태 표시
            if (sorted.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.style.cssText = 'text-align: center; padding: 40px; color: var(--text-dim); font-size: 0.9em;';
                emptyMessage.innerHTML = '<i class="fas fa-info-circle"></i> 측정된 데이터가 없습니다';
                statsList.appendChild(emptyMessage);
                return;
            }
            
            const totalSum = sorted.reduce((sum, [uid,stat]) => sum + (stat[""].all.total_damage || 0), 0);
            
            // 뷰 모드에 따라 다른 클래스 적용
            if (viewMode === 'list') {
                statsList.className = 'damage-list-container';
                renderListView(sorted, totalSum);
            } else {
                statsList.className = 'damage-cards-container';
                renderCardView(sorted, totalSum);
            }
        }
        
        // 카드 뷰 렌더링
        function renderCardView(sorted, totalSum) {
            const statsList = document.getElementById('damage-stats-list');
            
            sorted.forEach(([user_id, item], idx) => {
                const stat = item[""];
                const total = stat.all.total_damage || 0;
                const critRate = calcCritHitPercent(stat);
                const addhitRate = calcAddHitPercent(stat);
                const dps = Math.floor(total/(getRuntimeSec()+1));
                const totalRate = sorted.length === 1 ? 1 : totalSum > 0 ? total / totalSum : 0;
                const jobName = userData[user_id] ? userData[user_id].job : user_id;
                const isSelf = selfID == user_id;
                
                // 카드 생성
                const card = document.createElement('div');
                card.className = 'damage-card';
                if (idx === 0) card.classList.add('rank-1');
                else if (idx === 1) card.classList.add('rank-2');
                else if (idx === 2) card.classList.add('rank-3');
                if (isSelf) card.classList.add('me');
                
                card.dataset.userId = user_id;
                
                // 순위별 아이콘 추가
                let rankIcon = '';
                if (idx === 0) rankIcon = '<i class="fas fa-trophy rank-icon-glow" style="color: var(--accent-gold); margin-left: 4px; text-shadow: 0 0 10px var(--accent-gold);"></i>';
                else if (idx === 1) rankIcon = '<i class="fas fa-award rank-icon-glow" style="color: var(--accent-silver); margin-left: 4px; text-shadow: 0 0 10px var(--accent-silver);"></i>';
                else if (idx === 2) rankIcon = '<i class="fas fa-award rank-icon-glow" style="color: var(--accent-bronze); margin-left: 4px; text-shadow: 0 0 10px var(--accent-bronze);"></i>';
                
                card.innerHTML = `
                    <div class="card-rank">#${idx + 1}</div>
                    <div class="card-header">
                        <div class="card-job">${jobName}${rankIcon}</div>
                        ${isSelf ? '<div class="card-me-badge">ME</div>' : ''}
                    </div>
                    <div class="card-main-stat">
                        <div class="card-dps">${dps.toLocaleString()}</div>
                        <div class="card-dps-label">DPS</div>
                    </div>
                    <div class="card-stats">
                        <div class="card-stat">
                            <div class="card-stat-value">${total.toLocaleString()}</div>
                            <div class="card-stat-label">총 데미지</div>
                        </div>
                        <div class="card-stat">
                            <div class="card-stat-value">${(totalRate * 100).toFixed(1)}%</div>
                            <div class="card-stat-label">점유율</div>
                        </div>
                        <div class="card-stat">
                            <div class="card-stat-value">${critRate}%</div>
                            <div class="card-stat-label">크리티컬</div>
                        </div>
                        <div class="card-stat">
                            <div class="card-stat-value">${addhitRate}%</div>
                            <div class="card-stat-label">추가타</div>
                        </div>
                    </div>
                    <div class="card-progress">
                        <div class="card-progress-bar" style="width: ${totalRate * 100}%"></div>
                    </div>
                `;
                
                statsList.appendChild(card);
            });
        }
        
        // 리스트 뷰 렌더링
        function renderListView(sorted, totalSum) {
            const statsList = document.getElementById('damage-stats-list');
            
            // 헤더 추가
            const header = document.createElement('div');
            header.className = 'damage-list-item';
            header.style.cssText = 'background: var(--bg-soft); font-weight: 600; font-size: 0.85em; color: var(--text-dim); cursor: default;';
            header.innerHTML = `
                <div class="list-rank">순위</div>
                <div>직업</div>
                <div>DPS</div>
                <div>총 데미지</div>
                <div>점유율</div>
                <div class="list-stat">크리율</div>
                <div class="list-stat">추가타</div>
                <div class="list-stat">공증</div>
                <div class="list-stat">피증</div>
            `;
            statsList.appendChild(header);
            
            sorted.forEach(([user_id, item], idx) => {
                const stat = item[""];
                const total = stat.all.total_damage || 0;
                const critRate = calcCritHitPercent(stat);
                const addhitRate = calcAddHitPercent(stat);
                const atkbuff = divideForDis(stat.buff.total_atk, stat.buff.total_count);
                const dmgbuff = divideForDis(stat.buff.total_dmg, stat.buff.total_count);
                const dps = Math.floor(total/(getRuntimeSec()+1));
                const totalRate = sorted.length === 1 ? 1 : totalSum > 0 ? total / totalSum : 0;
                const jobName = userData[user_id] ? userData[user_id].job : user_id;
                const isSelf = selfID == user_id;
                
                // 순위별 아이콘
                let rankIcon = '';
                if (idx === 0) rankIcon = '<i class="fas fa-trophy" style="color: var(--accent-gold); text-shadow: 0 0 10px var(--accent-gold);"></i>';
                else if (idx === 1) rankIcon = '<i class="fas fa-award" style="color: var(--accent-silver); text-shadow: 0 0 10px var(--accent-silver);"></i>';
                else if (idx === 2) rankIcon = '<i class="fas fa-award" style="color: var(--accent-bronze); text-shadow: 0 0 10px var(--accent-bronze);"></i>';
                
                const listItem = document.createElement('div');
                listItem.className = 'damage-list-item';
                if (idx === 0) listItem.classList.add('rank-1');
                else if (idx === 1) listItem.classList.add('rank-2');
                else if (idx === 2) listItem.classList.add('rank-3');
                if (isSelf) listItem.classList.add('me');
                
                listItem.dataset.userId = user_id;
                
                listItem.innerHTML = `
                    <div class="list-damage-bar" style="width: ${totalRate * 100}%"></div>
                    <div class="list-rank ${idx < 3 ? 'rank-' + (idx + 1) : ''}">${idx + 1}</div>
                    <div class="list-job">
                        ${jobName}
                        ${rankIcon}
                        ${isSelf ? '<span style="color: var(--accent-me); font-size: 0.8em; font-weight: 700;">[ME]</span>' : ''}
                    </div>
                    <div class="list-dps">${dps.toLocaleString()}</div>
                    <div class="list-damage">${total.toLocaleString()}</div>
                    <div class="list-share">${(totalRate * 100).toFixed(1)}%</div>
                    <div class="list-stat">${critRate}%</div>
                    <div class="list-stat">${addhitRate}%</div>
                    <div class="list-stat">${atkbuff}</div>
                    <div class="list-stat">${dmgbuff}</div>
                `;
                
                // 클릭 이벤트
                listItem.addEventListener('click', () => {
                    showDetailModal(user_id);
                });
                
                statsList.appendChild(listItem);
            });
        }

        function calcSortedItems(){
            const tid = getTargetID();
            const statsSource = singleMode ? damageDB2 : damageDB;
            
            // 데이터 소스가 없거나 비어있으면 빈 배열 반환
            if (!statsSource || Object.keys(statsSource).length === 0) return [];
            
            // 초기화된 기본 데이터만 있는 경우도 빈 배열 반환
            if (Object.keys(statsSource).length === 1 && statsSource[0] && 
                Object.keys(statsSource[0]).length === 1 && statsSource[0][0]) {
                return [];
            }
            
            const sorted = Object.entries(statsSource)
                .filter(([user_id, item]) => {
                    // 유효한 데이터만 필터링
                    return item && item[tid] && item[tid][""] && 
                           item[tid][""].all && item[tid][""].all.total_damage > 0;
                })
                .filter(([user_id, item]) => {
                    // 유저 데이터가 있는 경우만
                    return userData[user_id] && userData[user_id].job && userData[user_id].job.length > 0;
                })
                .sort((a, b) => {
                    const aDamage = (a[1][tid] && a[1][tid][""] && a[1][tid][""].all) ? a[1][tid][""].all.total_damage : 0;
                    const bDamage = (b[1][tid] && b[1][tid][""] && b[1][tid][""].all) ? b[1][tid][""].all.total_damage : 0;
                    return bDamage - aDamage;
                })
                .map(([key, item]) => [key, item[tid]])
                .slice(0, 12);

            return sorted;
        }

        function clearDB () {
            damageDB  = {0:{0:{"":{}}}}
            damageDB2 = {0:{0:{"":{}}}}
            buffDB = {};
            selfID = 0;
            enemyData = {}
            userData = {}
            hitTime = {};
            userTmpData = null;
   
            selectedDetailUserId = null;
            skillDetailOpened = {};
            Object.keys(selectedDetailSkillName).forEach(key => delete selectedDetailSkillName[key]);
            
            // 차트 완전 초기화
            dpsChartData = [];
            chartInitialized = false;
            if (dpsChart) {
                try {
                    dpsChart.destroy();
                } catch (e) {
                    console.error('차트 제거 중 오류:', e);
                }
                dpsChart = null;
            }
            
            // 모든 UI 초기화
            document.getElementById('runtime-text').textContent = '0.00초';
            document.getElementById('total-text').textContent = '0';
            document.getElementById('total-dps-text').textContent = '0';
            
            // 카드 리스트 초기화 및 빈 메시지 표시
            const statsList = document.getElementById('damage-stats-list');
            statsList.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-dim); font-size: 0.9em;"><i class="fas fa-info-circle"></i> 측정된 데이터가 없습니다</div>';
            
            // 상세 패널 숨기기
            document.getElementById('detail-panel').style.display = 'none';
            
            // 차트 패널 숨기기
            const chartPanel = document.getElementById('chartPanel');
            if (chartPanel) {
                chartPanel.style.display = 'none';
            }
            
            // 모달 닫기
            const modal = document.getElementById('detailModal');
            if (modal && modal.classList.contains('open')) {
                modal.classList.remove('open');
            }
            
            // 버프 리스트 초기화
            const buffLists = document.querySelectorAll('.buff-list');
            buffLists.forEach(list => {
                list.innerHTML = '';
            });
            
            // 스킬 상세 패널 초기화
            const skillPanel = document.getElementById('skill-detail-panel');
            if (skillPanel) {
                skillPanel.innerHTML = '';
            }
            
            // 마지막 데이터 시간 리셋
            lastDataTime = Date.now();
            
            console.log('모든 데이터가 초기화되었습니다.');
        }
        
        // 자동 초기화 체크 함수
        function checkAutoReset() {
            const now = Date.now();
            const timeSinceLastData = now - lastDataTime;
            
            // 1분 이상 데이터가 없고, 데이터가 있는 경우에만
            if (timeSinceLastData >= autoResetTimeout && getTotalDamage() > 0) {
                // 자동 초기화 확인 대화상자
                if (confirm('1분 이상 데이터 수집이 없었습니다.\n데이터를 초기화하시겠습니까?')) {
                    clearDB();
                    renderDamageRanks();
                } else {
                    // 취소하면 타이머 재설정
                    lastDataTime = Date.now();
                }
            }
        }
        
        // 자동 초기화 타이머 시작
        function startAutoResetTimer() {
            if (!autoResetInterval) {
                autoResetInterval = setInterval(checkAutoReset, 5000); // 5초마다 체크
            }
        }

        (function() {
            singleMode = localStorage.getItem('singleMode') === 'true';
            bossMode = localStorage.getItem('bossMode') ?? "모두";
            buffVisibleTypes = JSON.parse(localStorage.getItem('buffVisibleTypes')) || {};

            const calcModeCheckBox = document.getElementById('calcmodechkbox');
            const singleModeCheckbox = document.getElementById('singleModeCheckbox');
            calcModeCheckBox.onchange = () => {
                bossMode = calcModeCheckBox.value;                
                renderDamageRanks();
                localStorage.setItem('bossMode', bossMode);
            };
            singleModeCheckbox.onchange = () => {
                singleMode = singleModeCheckbox.checked;                
                renderDamageRanks();
                localStorage.setItem('singleMode', singleMode);
            };
            singleModeCheckbox.checked = singleMode
            calcModeCheckBox.value = bossMode


            const group = document.getElementById('buff-radio-groups');
            const buttons = group.querySelectorAll('.btn');

            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const labels = Array.from(buttons).map(b=>b.innerText.trim())
                    const label = btn.innerText.trim();
                    const state = btn.classList.contains('active');

                    if (label == "전체"){
                        if(state == true){
                            labels.forEach(l=>buffVisibleTypes[l]=false);
                            buttons.forEach(b => b.classList.remove('active'));
                        }
                        else{
                            labels.forEach(l=>buffVisibleTypes[l]=true);
                            buttons.forEach(b => b.classList.add('active'));
                        }
                    }
                    else{
                        if(state == true){                            
                            buffVisibleTypes[label] = false;
                            btn.classList.remove('active');
                            buttons[0].classList.remove('active');
                        }
                        else {
                            buffVisibleTypes[label] = true;
                            btn.classList.add('active');
                        }
                    }

                    localStorage.setItem('buffVisibleTypes', JSON.stringify(buffVisibleTypes));
                    renderDamageRanks();
                });
            });
            
           buttons.forEach(btn => {
                const labels = Array.from(buttons).map(b=>b.innerText.trim())
                const label = btn.innerText.trim();
                let state = false;
                if (label == "전체"){
                    state =  Object.values(buffVisibleTypes).every(v => v === true);
                }
                else{
                    state = buffVisibleTypes[label]
                }
                if(state == false){
                    btn.classList.remove('active');
                }
                else {
                    btn.classList.add('active');
                }                
            });

        })();

        const saveAllBtn = document.getElementById('saveAllBtn');
        saveAllBtn.onclick = () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
            function getKoreaTime(){
                const now = new Date();
                const kst = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
                const yyyy = kst.getFullYear();
                const mm = String(kst.getMonth() + 1).padStart(2, '0');
                const dd = String(kst.getDate()).padStart(2, '0');
                const HH = String(kst.getHours()).padStart(2, '0');
                const MM = String(kst.getMinutes()).padStart(2, '0');
                const SS = String(kst.getSeconds()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}T${HH}-${MM}-${SS}`;
            }
            const data = {
                damageDB,
                damageDB2,
                buffDB,
                selfID,
                enemyData,
                userData,
                hitTime
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `savedata_${getKoreaTime()}.json`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        };

        // 데이터 불러오기 버튼 및 파일 input 생성
        const loadAllBtn = document.getElementById('loadAllBtn');
        let fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json';

        loadAllBtn.onclick = () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
            fileInput.value = '';
            fileInput.click();
        };

        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    clearDB();
                    
                    const data = JSON.parse(ev.target.result);

                    // === 불러온 데이터 적용 ===
                    Object.assign(damageDB, data.damageDB || {});
                    Object.assign(damageDB2, data.damageDB2 || {});
                    Object.assign(buffDB, data.buffDB || {});
                    Object.assign(enemyData, data.enemyData || {});
                    Object.assign(userData, data.userData || {});
                    Object.assign(hitTime, data.hitTime || {});
                    selfID = data.selfID;

                    renderDamageRanks();
                    // alert('데이터를 성공적으로 불러왔습니다.');
                } catch (err) {
                    alert('불러오기 실패: ' + err);
                }
            };
            reader.readAsText(file, 'utf-8');
        };
        
        // 내보내기 메뉴 토글
        document.getElementById('exportBtn').onclick = (e) => {
            e.stopPropagation();
            const menu = document.getElementById('exportMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        };
        
        // 클릭 외부 시 메뉴 닫기
        document.addEventListener('click', () => {
            document.getElementById('exportMenu').style.display = 'none';
        });
        
        // 스크린샷 기능
        window.exportScreenshot = async () => {
            const statsPanel = document.querySelector('.panel:has(#damage-stats-list)');
            if (!statsPanel) return;
            
            // html2canvas 라이브러리 로드
            if (!window.html2canvas) {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
                document.head.appendChild(script);
                await new Promise(resolve => script.onload = resolve);
            }
            
            try {
                const canvas = await html2canvas(statsPanel, {
                    backgroundColor: '#0f0f0f',
                    scale: 2
                });
                
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `damage_meter_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                });
            } catch (err) {
                console.error('스크린샷 실패:', err);
            }
        };
        
        // CSV 내보내기
        window.exportCSV = () => {
            const sorted = calcSortedItems();
            const runtime = getRuntimeSec();
            
            let csv = 'Rank,Name,DPS,Total Damage,Damage Share,Critical Rate,Add Hit Rate\n';
            
            sorted.forEach(([user_id, item], idx) => {
                const stat = item[""];
                const total = stat.all.total_damage || 0;
                const critRate = calcCritHitPercent(stat);
                const addhitRate = calcAddHitPercent(stat);
                const dps = Math.floor(total/(runtime+1));
                const totalSum = sorted.reduce((sum, [uid,s]) => sum + (s[""].all.total_damage || 0), 0);
                const share = ((total/totalSum)*100).toFixed(1);
                const jobName = userData[user_id] ? userData[user_id].job : user_id;
                
                csv += `${idx+1},"${jobName}",${dps},${total},${share}%,${critRate}%,${addhitRate}%\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `damage_report_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        };
        
        // 클립보드 복사 (Discord용)
        window.copyToClipboard = () => {
            const sorted = calcSortedItems();
            const runtime = getRuntimeSec();
            const totalSum = sorted.reduce((sum, [uid,stat]) => sum + (stat[""].all.total_damage || 0), 0);
            
            let text = `**전투 시간**: ${runtime.toFixed(2)}초\n`;
            text += `**총 데미지**: ${totalSum.toLocaleString()}\n\n`;
            text += `**DPS 순위**\n`;
            
            sorted.slice(0, 10).forEach(([user_id, item], idx) => {
                const stat = item[""];
                const total = stat.all.total_damage || 0;
                const dps = Math.floor(total/(runtime+1));
                const share = ((total/totalSum)*100).toFixed(1);
                const jobName = userData[user_id] ? userData[user_id].job : user_id;
                const medal = idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : `${idx+1}.`;
                
                text += `${medal} **${jobName}** - ${dps.toLocaleString()} DPS (${share}%)\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => {
                // 복사 완료 알림
                const btn = document.getElementById('exportBtn');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> 복사됨!';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                }, 2000);
            });
        };
        
        setInterval(() => {
            const elapsed = getRuntimeSec();
            const total = getTotalDamage(singleMode);
            document.getElementById('runtime-text').textContent = `${elapsed.toFixed(2)}초`;
            document.getElementById('total-text').textContent = `${total.toLocaleString()}`;
            document.getElementById('total-dps-text').textContent = `${Math.round(total/(elapsed+1)).toLocaleString()}`;
        }, 500);

        (function(){
            let isConnected = false;

            function onConnectionChanged(connected) {
                isConnected = connected;
                const ctrl = document.getElementById('connectSym');
                if (connected) {
                    ctrl.classList.add("status-connected")
                } else {
                    ctrl.classList.remove("status-connected")
                }
            }
            document.getElementById('connectBtn').onclick = () => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.close();
                }
                else{
                    connect()
                }
            }
            document.getElementById('clearBtn').onclick = () => {
                // 모든 데이터 초기화
                clearDB();
                
                // WebSocket 재연결로 서버 데이터도 초기화
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.close();
                }
                connect();
                
                // UI 렌더링
                renderDamageRanks();
            };

            function connect() {
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    onConnectionChanged(true);
                };

                ws.onmessage = (event) => {
                    try {
                        const obj = JSON.parse(event.data);
                        switch (obj.type) {
                            case "damage":
                                damageDB   = obj.data.damage;
                                damageDB2  = obj.data.damage2;
                                selfID    = obj.data.self_id;
                                enemyData  = obj.data.enemy;
                                hitTime    = obj.data.hit_time;
                                buffDB = obj.data.buff;
                                if (obj.data.user) {
                                    userData = obj.data.user;
                                }
                                userTmpData = obj.data.user_tmp;
                                
                                // 데이터 수신 시간 업데이트
                                lastDataTime = Date.now();
                                
                                if (render_timeout) return;
                                render_timeout = setTimeout(() => {
                                    renderDamageRanks();
                                    // 차트 업데이트는 별도 타이머로 관리
                                    if (!chartUpdateTimeout && isTabActive) {
                                        chartUpdateTimeout = setTimeout(() => {
                                            updateDPSChart();
                                            chartUpdateTimeout = null;
                                        }, 500); // 500ms 주기로 차트 업데이트
                                    }
                                    render_timeout = null;
                                }, 100);    
                                break;
                        }
                    } catch (e) {
                        console.log("메시지 처리 오류:", e, event.data);
                    }
                };

                ws.onclose = () => {
                    onConnectionChanged(false);
                };

                ws.onerror = (err) => {
                    onConnectionChanged(false);
                };
            }

            connect();
            
            // DOM 로드 완료 후 이벤트 설정
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupEventListeners);
            } else {
                setupEventListeners();
            }
            
            function setupEventListeners() {
                // 설정 패널 이벤트
                const settingsBtn = document.getElementById('settingsBtn');
                const settingsClose = document.getElementById('settingsClose');
                const settingsPanel = document.getElementById('settingsPanel');
                
                if (settingsBtn && settingsPanel) {
                    settingsBtn.onclick = () => {
                        settingsPanel.classList.add('open');
                    };
                }
                
                if (settingsClose && settingsPanel) {
                    settingsClose.onclick = () => {
                        settingsPanel.classList.remove('open');
                    };
                }
                
                // 토글 스위치 이벤트
                document.querySelectorAll('.toggle-switch').forEach(toggle => {
                    toggle.onclick = () => {
                        toggle.classList.toggle('active');
                        
                        // 차트 토글 처리
                        if (toggle.id === 'chartToggle') {
                            const chartPanel = document.getElementById('chartPanel');
                            if (chartPanel) {
                                if (toggle.classList.contains('active')) {
                                    // 차트가 표시되어야 하는데 데이터가 있으면 표시
                                    if (getTotalDamage() > 0) {
                                        chartPanel.style.display = 'block';
                                        if (!chartInitialized) {
                                            initDPSChart();
                                        }
                                    }
                                } else {
                                    chartPanel.style.display = 'none';
                                }
                                localStorage.setItem('chartEnabled', toggle.classList.contains('active'));
                            }
                        }
                        
                        // 애니메이션 토글 처리
                        if (toggle.id === 'animationToggle') {
                            if (toggle.classList.contains('active')) {
                                document.body.classList.remove('no-animation');
                            } else {
                                document.body.classList.add('no-animation');
                            }
                            localStorage.setItem('animationEnabled', toggle.classList.contains('active'));
                        }
                        
                        // 자동 초기화 토글 처리
                        if (toggle.id === 'autoResetToggle') {
                            if (toggle.classList.contains('active')) {
                                startAutoResetTimer();
                            } else {
                                if (autoResetInterval) {
                                    clearInterval(autoResetInterval);
                                    autoResetInterval = null;
                                }
                            }
                            localStorage.setItem('autoResetEnabled', toggle.classList.contains('active'));
                        }
                    };
                });
                
                // 저장된 설정 복원
                const chartEnabled = localStorage.getItem('chartEnabled') !== 'false';
                const animationEnabled = localStorage.getItem('animationEnabled') !== 'false';
                const autoResetEnabled = localStorage.getItem('autoResetEnabled') !== 'false';
                
                document.getElementById('chartToggle').classList.toggle('active', chartEnabled);
                document.getElementById('animationToggle').classList.toggle('active', animationEnabled);
                document.getElementById('autoResetToggle').classList.toggle('active', autoResetEnabled);
                
                // 초기 상태 적용
                if (!chartEnabled && document.getElementById('chartPanel')) {
                    document.getElementById('chartPanel').style.display = 'none';
                }
                if (!animationEnabled) {
                    document.body.classList.add('no-animation');
                }
                if (!autoResetEnabled && autoResetInterval) {
                    clearInterval(autoResetInterval);
                    autoResetInterval = null;
                }
                
                // 테마 선택 이벤트
                const themeSelect = document.getElementById('themeSelect');
                if (themeSelect) {
                    // 저장된 테마 복원
                    const savedTheme = localStorage.getItem('theme') || 'cyberpunk';
                    themeSelect.value = savedTheme;
                    document.body.setAttribute('data-theme', savedTheme);
                    
                    themeSelect.onchange = () => {
                        const theme = themeSelect.value;
                        document.body.setAttribute('data-theme', theme);
                        localStorage.setItem('theme', theme);
                    };
                }
                
                // 뷰 모드 선택 이벤트
                const viewModeSelect = document.getElementById('viewModeSelect');
                if (viewModeSelect) {
                    // 저장된 뷰 모드 복원
                    const savedViewMode = localStorage.getItem('viewMode') || 'card';
                    viewMode = savedViewMode;
                    viewModeSelect.value = savedViewMode;
                    
                    viewModeSelect.onchange = () => {
                        viewMode = viewModeSelect.value;
                        localStorage.setItem('viewMode', viewMode);
                        renderDamageRanks(); // 즉시 렌더링 업데이트
                    };
                }
            }
            
            // Chart.js는 로드하되 초기화는 하지 않음
            // 데이터가 들어올 때 updateDPSChart에서 자동으로 초기화됨
            
            // 자동 초기화 타이머 시작
            startAutoResetTimer();
            
            // 탭 활성화 상태 감지
            document.addEventListener('visibilitychange', () => {
                isTabActive = !document.hidden;
                if (!isTabActive) {
                    // 탭이 비활성화되면 차트 업데이트 중지
                    if (chartUpdateTimeout) {
                        clearTimeout(chartUpdateTimeout);
                        chartUpdateTimeout = null;
                    }
                }
            });
        })()
    </script>
    
    <!-- 상세정보 모달 -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">상세 정보</h2>
                <button class="modal-close" onclick="document.getElementById('detailModal').classList.remove('open')">
                    <i class="fas fa-xmark"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 동적으로 내용 추가 -->
            </div>
        </div>
    </div>

    <!-- 설정 패널 -->
    <div id="settingsPanel">
        <div class="settings-header">
            <h3 style="margin: 0; color: var(--text-color);">
                <i class="fas fa-cog" style="color: var(--primary-color);"></i> 설정
            </h3>
            <button id="settingsClose" style="background: transparent; border: none; color: var(--text-color); font-size: 1.5em; cursor: pointer; padding: 0;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="settings-content">
            <div class="setting-item">
                <div class="setting-label">
                    <span><i class="fas fa-chart-line"></i> 실시간 차트 표시</span>
                    <div class="toggle-switch active" id="chartToggle"></div>
                </div>
                <p style="font-size: 0.85em; color: var(--text-dim); margin: 4px 0 0 0;">DPS 추이를 실시간으로 확인합니다.</p>
            </div>
            <div class="setting-item">
                <div class="setting-label">
                    <span><i class="fas fa-magic"></i> 애니메이션 효과</span>
                    <div class="toggle-switch active" id="animationToggle"></div>
                </div>
                <p style="font-size: 0.85em; color: var(--text-dim); margin: 4px 0 0 0;">UI 애니메이션을 활성화합니다.</p>
            </div>
            <div class="setting-item">
                <div class="setting-label">
                    <span><i class="fas fa-bell"></i> 자동 초기화 알림</span>
                    <div class="toggle-switch active" id="autoResetToggle"></div>
                </div>
                <p style="font-size: 0.85em; color: var(--text-dim); margin: 4px 0 0 0;">1분간 데이터 없을 시 알림을 표시합니다.</p>
            </div>
            <div class="setting-item">
                <div class="setting-label">
                    <span><i class="fas fa-palette"></i> 테마 선택</span>
                </div>
                <select id="themeSelect" class="combobox" style="width: 100%; margin-top: 8px;">
                    <option value="dark">다크 테마 (기본)</option>
                    <option value="soft-dark">소프트 다크</option>
                    <option value="high-contrast">고대비</option>
                </select>
                <p style="font-size: 0.85em; color: var(--text-dim); margin: 4px 0 0 0;">UI 색상 테마를 변경합니다.</p>
            </div>
            <div class="setting-item">
                <div class="setting-label">
                    <span><i class="fas fa-th"></i> 뷰 모드</span>
                </div>
                <select id="viewModeSelect" class="combobox" style="width: 100%; margin-top: 8px;">
                    <option value="card">카드형</option>
                    <option value="list">리스트형</option>
                </select>
                <p style="font-size: 0.85em; color: var(--text-dim); margin: 4px 0 0 0;">데미지 통계 표시 방식을 변경합니다.</p>
            </div>
        </div>
    </div>
    
</body>
</html>